from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import os

app = Flask(__name__)

line_bot_api = LineBotApi(os.getenv("CHANNEL_ACCESS_TOKEN"))
handler = WebhookHandler(os.getenv("CHANNEL_SECRET"))

@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature")
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return "OK", 200


@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_text = event.message.text.strip().lower()

    if user_text == "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ":
        reply = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö üòä ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°"

    elif user_text == "help":
        reply = (
            "üìö Bookfair Bot ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á\n"
            "- ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ'\n"
            "- ‡∏û‡∏¥‡∏°‡∏û‡πå 'help'\n"
            "(‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤)"
        )

    else:
        reply = "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ ü•∫ ‡∏û‡∏¥‡∏°‡∏û‡πå 'help' ‡πÑ‡∏î‡πâ‡∏ô‡∏∞"

    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=reply)
    )
